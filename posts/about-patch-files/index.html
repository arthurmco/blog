<!doctype html><html lang=en><head><title>Coisas interessantes sobre patchfiles :: Blog do Arthur M.</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Hoje eu precisei editar um arquivo .patch na mão. Achei interessante
compartilhar como é o formato, já que não é algo que se vê todo dia
"><meta name=keywords content="patch,diff,git diff"><meta name=robots content="noodp"><link rel=canonical href=https://arthurmco.github.io/blog/posts/about-patch-files/><link rel=stylesheet href=https://arthurmco.github.io/blog/assets/style.css><link rel=stylesheet href=https://arthurmco.github.io/blog/assets/red.css><link rel=apple-touch-icon href=https://arthurmco.github.io/blog/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://arthurmco.github.io/blog/img/favicon/red.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Coisas interessantes sobre patchfiles"><meta property="og:description" content="Hoje eu precisei editar um arquivo .patch na mão. Achei interessante
compartilhar como é o formato, já que não é algo que se vê todo dia
"><meta property="og:url" content="https://arthurmco.github.io/blog/posts/about-patch-files/"><meta property="og:site_name" content="Blog do Arthur M."><meta property="og:image" content="https://arthurmco.github.io/blog/images/about-patch-cover.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-03-13 14:28:37 -0300 -0300"></head><body class=red><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=https://arthurmco.github.io/blog/><div class=logo>Blog do Arthur M.</div></a></div></div></header><div class=content><div class=post><h1 class=post-title><a href=https://arthurmco.github.io/blog/posts/about-patch-files/>Coisas interessantes sobre patchfiles</a></h1><div class=post-meta><span class=post-date>2022-03-13
[Modificado em: 2022-03-13]</span>
<span class=post-author>:: Arthur M</span>
<span class=post-reading-time><br>4
minutos
estimados de leitura</span></div><span class=post-tags>#<a href=https://arthurmco.github.io/blog/tags/tips/>tips</a>&nbsp;</span>
<img src=https://arthurmco.github.io/blog/images/about-patch-cover.png class=post-cover alt="Coisas interessantes sobre patchfiles" title="Cover Image"><div class=post-content><div><p>Hoje eu precisei editar um arquivo <code>patch</code> na mão, algo relacionado
com um projeto pessoal meu.</p><p>Para quem não sabe, arquivos <code>patch</code> são aqueles com extensão .patch.
Eles têm um monte de linhas que começam com <code>+</code> e <code>-</code>.<br>A sintaxe desse arquivo é a mesma sintaxe que o comando <code>git diff</code>
mostra em um repositório válido,</p><p>Um arquivo diff é mais ou menos assim:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>
</span></span><span style=display:flex><span>diff --git a/src/common/CMakeLists.txt b/src/common/CMakeLists.txt
</span></span><span style=display:flex><span>index edeeeec..fcbe64c 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/common/CMakeLists.txt
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/common/CMakeLists.txt
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -48,13 +48,11 @@ add_dependencies(familyline-common input-flatbuffer input-ser-flatbuffer network
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> target_compile_features(familyline-common PRIVATE cxx_std_20)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> find_package(fmt 6...7.2 CONFIG REQUIRED)
</span></span><span style=display:flex><span><span style=color:#f92672>-find_package(ZLIB REQUIRED)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span> find_package(tl-expected 1 CONFIG REQUIRED)
</span></span><span style=display:flex><span> find_package(nlohmann_json REQUIRED)
</span></span><span style=display:flex><span> find_package(FlatBuffers REQUIRED)
</span></span><span style=display:flex><span> find_package(SDL2 CONFIG)
</span></span><span style=display:flex><span> find_package(range-v3 CONFIG)
</span></span><span style=display:flex><span><span style=color:#f92672>-find_package(glm REQUIRED)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span> 
</span></span><span style=display:flex><span> if (FLINE_USE_VCPKG)
</span></span><span style=display:flex><span>   include(${CMAKE_TOOLCHAIN_FILE})
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -79,8 +77,9 @@ else()
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   target_link_libraries(familyline-common PUBLIC ${CURLPP_LDFLAGS})
</span></span><span style=display:flex><span>   target_include_directories(familyline-common PUBLIC ${CURLPP_INCLUDE_DIRS})
</span></span><span style=display:flex><span>   endif()
</span></span><span style=display:flex><span><span style=color:#a6e22e>+  pkg_search_module(ZLIB REQUIRED zlib)
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 
</span></span><span style=display:flex><span><span style=color:#f92672>-  target_link_libraries(familyline-common PUBLIC fmt::fmt glm::glm ${ZLIB_LIBRARIES})
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+  target_link_libraries(familyline-common PUBLIC fmt::fmt glm ${ZLIB_LIBRARIES})
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span>   target_link_libraries(familyline-common PUBLIC tl::expected range-v3::range-v3)
</span></span><span style=display:flex><span>   target_link_libraries(familyline-common PUBLIC nlohmann_json::nlohmann_json)
</span></span><span style=display:flex><span>   target_include_directories(familyline-common PUBLIC
</span></span><span style=display:flex><span>diff --git a/src/common/generated.cmake b/src/common/generated.cmake
</span></span><span style=display:flex><span>index d30ff1c..b105a41 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/src/common/generated.cmake
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/common/generated.cmake
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -5,6 +5,8 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> # called INPUT_FLATBUFFER_INCLUDE, where the generated header file
</span></span><span style=display:flex><span> # is.
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>+# TODO: solve the issue of us having to run cmake twice to get the flatbuffers path
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> include_guard(GLOBAL)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> include(&#34;${CMAKE_SOURCE_DIR}/cmake/BuildFlatBuffers.cmake&#34;)
</span></span><span style=display:flex><span>diff --git a/tools/bump_version.py b/tools/bump_version.py
</span></span><span style=display:flex><span>index 5b79583..46f736c 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/tools/bump_version.py
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/tools/bump_version.py
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -127,7 +127,7 @@ update_cmakelists(current_ver, next_ver)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ####################
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> os.system(&#34;git add CMakeLists.txt&#34;)
</span></span><span style=display:flex><span><span style=color:#f92672>-os.system(&#34;git commit -m \&#34;Bump version (v{} -&gt; v{})\&#34;&#34;.format(current_ver, next_ver))
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+os.system(&#34;git commit --no-verify -m \&#34;Bump version (v{} -&gt; v{})\&#34;&#34;.format(current_ver, next_ver))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 
</span></span><span style=display:flex><span> ####################
</span></span></code></pre></div><p>Existem vários formatos de arquivos de patch. O mais comum é esse aí de cima,
chamado de <code>unified format</code></p><p>Um arquivo de patch pode conter vários arquivos. Eles são delimitados
por duas coisas:</p><ul><li>o comando usado pra gerar o diff:</li></ul><pre tabindex=0><code>diff --git a/tools/bump_version.py b/tools/bump_version.py
index 5b79583..46f736c 100644 
</code></pre><ul><li>o <code>header</code> do arquivo:</li></ul><pre tabindex=0><code>--- a/tools/bump_version.py
+++ b/tools/bump_version.py
</code></pre><p>Opcionalmente, esse header pode conter uma data. É útil para ver se o
seu arquivo é mais novo ou mais velho do que o patch</p><pre tabindex=0><code>--- a/tools/bump_version.py    2022-03-07 01:34:08.815661222 -0300
+++ b/tools/bump_version.py    2022-03-09 18:29:20.993654217 -0300 
</code></pre><p>O <code>---</code> delimita o arquivo &ldquo;antigo&rdquo;. O <code>+++</code> delimita o arquivo
&ldquo;novo&rdquo;, que vai surgir depois do path.</p><p>O que conta pro formato é o caminho depois do <code>a/</code> ou do <code>b</code>, esses
dois nomes são só de referência</p><p>Depois disso, para cada arquivo, nós temos vários &ldquo;chunks&rdquo;, pedaços de alteração.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#75715e>@@ -127,7 +127,7 @@ update_cmakelists(current_ver, next_ver)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> ####################
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> os.system(&#34;git add CMakeLists.txt&#34;)
</span></span><span style=display:flex><span><span style=color:#f92672>-os.system(&#34;git commit -m \&#34;Bump version (v{} -&gt; v{})\&#34;&#34;.format(current_ver, next_ver))
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+os.system(&#34;git commit --no-verify -m \&#34;Bump version (v{} -&gt; v{})\&#34;&#34;.format(current_ver, next_ver))
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 
</span></span><span style=display:flex><span> ####################
</span></span></code></pre></div><p>O formato é mais ou menos assim:</p><p><code>@@ -linhaA, quantidadeA +linhaB, quantidadeB @@</code></p><p>A <code>linhaA</code> é o número da linha onde o chunk começa, onde a alteração
vai acontecer no arquivo antigo. A <code>quantidadeA</code> é a quantidade do
número de linhas nesse &ldquo;chunk&rdquo; no arquivo original</p><p>A <code>linhaB</code> é o número da linha onde o chunk começa, onde a alteração
vai acontecer no arquivo novo. A <code>quantidadeB</code> é a quantidade do
número de linhas nesse &ldquo;chunk&rdquo; depois que todas as alterações forem
aplicadas.</p><p>Por exemplo, nesse chunk aí de cima, ele começa na linha 127 do
arquivo, temos 7 linhas nele antes das alterações, e 7 linhas nele
depois</p><p>Nesse aqui:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#75715e>@@ -48,13 +48,11 @@ add_dependencies(familyline-common input-flatbuffer input-ser-flatbuffer network
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> target_compile_features(familyline-common PRIVATE cxx_std_20)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> find_package(fmt 6...7.2 CONFIG REQUIRED)
</span></span><span style=display:flex><span><span style=color:#f92672>-find_package(ZLIB REQUIRED)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span> find_package(tl-expected 1 CONFIG REQUIRED)
</span></span><span style=display:flex><span> find_package(nlohmann_json REQUIRED)
</span></span><span style=display:flex><span> find_package(FlatBuffers REQUIRED)
</span></span><span style=display:flex><span> find_package(SDL2 CONFIG)
</span></span><span style=display:flex><span> find_package(range-v3 CONFIG)
</span></span><span style=display:flex><span><span style=color:#f92672>-find_package(glm REQUIRED)
</span></span></span><span style=display:flex><span><span style=color:#f92672></span> 
</span></span><span style=display:flex><span> if (FLINE_USE_VCPKG)
</span></span><span style=display:flex><span>   include(${CMAKE_TOOLCHAIN_FILE})
</span></span></code></pre></div><p>ele começa na linha 48 do arquivo original, temos 13 linhas nele antes
das alterações e teremos 11 linhas depois.</p><p>Depois disso, vêm algumas linhas do arquivo original, para dar
contexto.</p><p>As linhas sem nada antes são linhas que não sofrerão alterações.</p><p>As linhas com <code>-</code> serão removidas.</p><p>As linhas com <code>+</code> serão adicionadas.</p><hr><p>E é isso.</p><p>É um formato relativamente simples, mas bem útil para dizer
alterações.</p><p>Se você quiser mais detalhes sobre o formato, pode vir <a href="https://www.artima.com/weblogs/viewpost.jsp?thread=164293">nesse post do
Guido van
Rossum</a>,
onde ele escreveu uma mini-especificação do formato.</p></div></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//https-arthurmco-github-io-blog.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><footer class=footer><div class=footer__dates><h4>Archive</h4><ul id=date-archive><li><a href=https://arthurmco.github.io/blog/archive/202208>August 2022</a> (6)</li><li><a href=https://arthurmco.github.io/blog/archive/202207>July 2022</a> (2)</li><li><a href=https://arthurmco.github.io/blog/archive/202205>May 2022</a> (1)</li><li><a href=https://arthurmco.github.io/blog/archive/202204>April 2022</a> (1)</li><li><a href=https://arthurmco.github.io/blog/archive/202203>March 2022</a> (2)</li></optgroup><li><a href=https://arthurmco.github.io/blog/archive/202109>September 2021</a> (2)</li><li><a href=https://arthurmco.github.io/blog/archive/202104>April 2021</a> (1)</li><li><a href=https://arthurmco.github.io/blog/archive/202102>February 2021</a> (3)</li></optgroup></li></div><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a> :: forked by <a href=https://twitter.com/usrbinarthur>arthurmco</a></span></div></div></footer><script src=https://arthurmco.github.io/blog/assets/main.js></script>
<script src=https://arthurmco.github.io/blog/assets/prism.js></script></div></body></html>